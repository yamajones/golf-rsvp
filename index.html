<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Golf Night RSVP</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Suppress development warnings for personal use
    const originalWarn = console.warn;
    const originalError = console.error;
    console.warn = function(...args) {
      const msg = args.join(' ');
      if (msg.includes('tailwindcss.com should not be used in production') || 
          msg.includes('Babel transformer')) {
        return;
      }
      originalWarn.apply(console, args);
    };
    console.error = function(...args) {
      const msg = args.join(' ');
      if (msg.includes('tailwindcss.com should not be used in production') || 
          msg.includes('Babel transformer')) {
        return;
      }
      originalError.apply(console, args);
    };
  </script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAY7gquavno6nc1ieRvNI5mRcecyhewh1c",
      authDomain: "golf-rsvp.firebaseapp.com",
      databaseURL: "https://golf-rsvp-default-rtdb.firebaseio.com",
      projectId: "golf-rsvp",
      storageBucket: "golf-rsvp.firebasestorage.app",
      messagingSenderId: "538449310978",
      appId: "1:538449310978:web:d726157255826ad9d7fe1b"
    };

    // Initialize Firebase
    let database;
    try {
      if (typeof firebase !== 'undefined' && !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
      } else if (typeof firebase !== 'undefined' && firebase.apps.length) {
        database = firebase.database();
      }
    } catch (error) {
      console.error("Firebase initialization error:", error);
    }

    function GolfRSVP() {
      const [sessions, setSessions] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showCreateForm, setShowCreateForm] = useState(false);
      const [isAdmin, setIsAdmin] = useState(false);
      const [adminPassword, setAdminPassword] = useState('');
      const [firebaseError, setFirebaseError] = useState(false);
      
      // Form states
      const [newSessionTitle, setNewSessionTitle] = useState('');
      const [newSessionDate, setNewSessionDate] = useState('');
      const [newSessionTime, setNewSessionTime] = useState('');
      const [newSessionLocation, setNewSessionLocation] = useState('');
      const [newSessionMessage, setNewSessionMessage] = useState('');

      // Load sessions on mount and listen for changes
      useEffect(() => {
        if (!database) {
          setFirebaseError(true);
          setLoading(false);
          return;
        }

        const sessionsRef = database.ref('golf-sessions');
        
        // Listen for real-time updates
        const unsubscribe = sessionsRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            // Convert object to array and sort by date (newest first)
            const sessionsArray = Object.keys(data).map(key => ({
              ...data[key],
              id: key
            })).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            setSessions(sessionsArray);
          } else {
            setSessions([]);
          }
          setLoading(false);
        }, (error) => {
          console.error("Firebase read error:", error);
          setFirebaseError(true);
          setLoading(false);
        });

        // Cleanup listener on unmount
        return () => sessionsRef.off('value', unsubscribe);
      }, []);

      const createSession = () => {
        if (!newSessionTitle || !newSessionDate || !newSessionTime) {
          alert('Please enter title, date and time');
          return;
        }

        if (!database) {
          alert('Firebase is not configured. Please check the setup instructions.');
          return;
        }

        try {
          const newSession = {
            title: newSessionTitle,
            date: newSessionDate,
            time: newSessionTime,
            location: newSessionLocation || 'Garage',
            message: newSessionMessage || '',
            attendees: {},
            createdAt: new Date().toISOString()
          };

          // Push to Firebase (auto-generates unique ID)
          database.ref('golf-sessions').push(newSession);
          
          setNewSessionTitle('');
          setNewSessionDate('');
          setNewSessionTime('');
          setNewSessionLocation('');
          setNewSessionMessage('');
          setShowCreateForm(false);
        } catch (error) {
          console.error('Create session error:', error);
          alert('Failed to create session. Please try again.');
        }
      };

      const addAttendee = (sessionId, name, status) => {
        if (!name.trim()) {
          alert('Please enter your name');
          return;
        }

        if (!database) {
          alert('Firebase is not configured.');
          return;
        }

        try {
          const attendeeKey = name.trim().toLowerCase().replace(/\s+/g, '-');
          database.ref(`golf-sessions/${sessionId}/attendees/${attendeeKey}`).set({
            name: name.trim(),
            status: status,
            timestamp: new Date().toISOString()
          });
        } catch (error) {
          console.error('Add attendee error:', error);
          alert('Failed to add RSVP. Please try again.');
        }
      };

      const removeAttendee = (sessionId, attendeeKey) => {
        if (!database) return;
        
        if (confirm('Remove this RSVP?')) {
          database.ref(`golf-sessions/${sessionId}/attendees/${attendeeKey}`).remove();
        }
      };

      const deleteSession = (sessionId) => {
        if (!database) return;
        
        if (confirm('Are you sure you want to delete this session?')) {
          database.ref(`golf-sessions/${sessionId}`).remove();
        }
      };

      const handleAdminLogin = () => {
        if (adminPassword === 'golf123') {
          setIsAdmin(true);
          setAdminPassword('');
        } else {
          alert('Incorrect password');
        }
      };

      const shareSession = (session) => {
        const url = window.location.href;
        
        // Simple alert that always works
        window.prompt('Copy this link and share it:', url);
      };

      if (firebaseError) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-red-50 to-red-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-lg shadow-lg p-8 max-w-2xl">
              <h1 className="text-2xl font-bold text-red-900 mb-4">‚ö†Ô∏è Preview Mode - Firebase Not Available</h1>
              <p className="text-gray-700 mb-4">
                This app requires Firebase to work. The preview won't function, but it will work perfectly when deployed to Netlify.
              </p>
              <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <p className="text-blue-800 font-semibold">‚úÖ To use the app:</p>
                <ol className="list-decimal list-inside space-y-1 text-blue-700 mt-2">
                  <li>Upload this file to Netlify</li>
                  <li>Open the Netlify URL in your browser</li>
                  <li>The app will work perfectly!</li>
                </ol>
              </div>
              <p className="text-sm text-gray-600">
                Your Firebase is already configured correctly in the code.
              </p>
            </div>
          </div>
        );
      }

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center">
            <div className="text-xl text-green-800">Loading...</div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 py-4 px-3">
          <div className="max-w-3xl mx-auto">
            {/* Sessions List */}
            {sessions.length === 0 ? (
              <div className="bg-white rounded-lg shadow-md p-12 text-center">
                <div className="text-6xl mb-4">üèåÔ∏è</div>
                <p className="text-gray-500 text-lg">No upcoming golf sessions yet.</p>
                {isAdmin && <p className="text-gray-400 mt-2">Create one at the bottom to get started!</p>}
              </div>
            ) : (
              <div className="space-y-4">
                {sessions.map(session => (
                  <SessionCard
                    key={session.id}
                    session={session}
                    onAddAttendee={addAttendee}
                    onRemoveAttendee={removeAttendee}
                    onShare={shareSession}
                    onDelete={isAdmin ? deleteSession : null}
                  />
                ))}
              </div>
            )}

            {/* Admin Section */}
            <div className="bg-white rounded-lg shadow-md p-6 mt-8">
              {!isAdmin ? (
                <div>
                  <p className="text-sm text-gray-500 mb-3 text-center">Host Login</p>
                  <div className="flex gap-2">
                    <input
                      type="password"
                      placeholder="Host password to create sessions"
                      value={adminPassword}
                      onChange={(e) => setAdminPassword(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleAdminLogin()}
                      className="flex-1 px-4 py-2 border border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                    />
                    <button
                      onClick={handleAdminLogin}
                      className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                    >
                      Login
                    </button>
                  </div>
                </div>
              ) : (
                <div>
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-semibold text-green-900">Host Controls</h2>
                    <button
                      onClick={() => setIsAdmin(false)}
                      className="text-sm text-green-600 hover:text-green-800"
                    >
                      Logout
                    </button>
                  </div>
                  
                  {!showCreateForm ? (
                    <button
                      onClick={() => setShowCreateForm(true)}
                      className="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium"
                    >
                      + Create New Golf Session
                    </button>
                  ) : (
                    <div className="space-y-3">
                      <input
                        type="text"
                        placeholder="Event title (e.g., Garage Golf)"
                        value={newSessionTitle}
                        onChange={(e) => setNewSessionTitle(e.target.value)}
                        className="w-full px-4 py-2 border border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                      />
                      <input
                        type="date"
                        value={newSessionDate}
                        onChange={(e) => setNewSessionDate(e.target.value)}
                        className="w-full px-4 py-2 border border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                      />
                      <input
                        type="time"
                        value={newSessionTime}
                        onChange={(e) => setNewSessionTime(e.target.value)}
                        className="w-full px-4 py-2 border border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                      />
                      <input
                        type="text"
                        placeholder="Location (optional, default: Garage)"
                        value={newSessionLocation}
                        onChange={(e) => setNewSessionLocation(e.target.value)}
                        className="w-full px-4 py-2 border border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                      />
                      <textarea
                        placeholder="Custom message (optional)"
                        value={newSessionMessage}
                        onChange={(e) => setNewSessionMessage(e.target.value)}
                        rows="3"
                        className="w-full px-4 py-2 border border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                      />
                      <div className="flex gap-2">
                        <button
                          onClick={createSession}
                          className="flex-1 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                        >
                          Create Session
                        </button>
                        <button
                          onClick={() => setShowCreateForm(false)}
                          className="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="mt-8 text-center text-sm text-green-700">
              <p>üîÑ Real-time updates ‚Ä¢ Share the link with friends!</p>
            </div>
          </div>
        </div>
      );
    }

    function SessionCard({ session, onAddAttendee, onRemoveAttendee, onShare, onDelete }) {
      const [name, setName] = useState('');
      const [showNameInput, setShowNameInput] = useState(false);
      const [pendingStatus, setPendingStatus] = useState(null);
      const [editingAttendee, setEditingAttendee] = useState(null);
      const [editName, setEditName] = useState('');

      const handleRSVP = (status) => {
        if (!showNameInput) {
          setPendingStatus(status);
          setShowNameInput(true);
        } else {
          if (name.trim()) {
            onAddAttendee(session.id, name, status);
            setName('');
            setShowNameInput(false);
            setPendingStatus(null);
          }
        }
      };

      const handleEdit = (attendee) => {
        setEditingAttendee(attendee.key);
        setEditName(attendee.name);
      };

      const saveEdit = (attendeeKey, oldStatus) => {
        if (editName.trim() && editName !== '') {
          onAddAttendee(session.id, editName, oldStatus);
          // If name changed, remove old entry
          const oldKey = attendeeKey;
          const newKey = editName.trim().toLowerCase().replace(/\s+/g, '-');
          if (oldKey !== newKey) {
            onRemoveAttendee(session.id, oldKey);
          }
        }
        setEditingAttendee(null);
        setEditName('');
      };

      const cancelEdit = () => {
        setEditingAttendee(null);
        setEditName('');
      };

      // Convert attendees object to array
      const attendeesArray = session.attendees ? Object.keys(session.attendees).map(key => ({
        key: key,
        ...session.attendees[key]
      })) : [];

      const attendingCount = attendeesArray.filter(a => a.status === 'in').length;
      const outCount = attendeesArray.filter(a => a.status === 'out').length;
      const attendingList = attendeesArray.filter(a => a.status === 'in');
      const outList = attendeesArray.filter(a => a.status === 'out');

      const formatDate = (dateStr) => {
        try {
          const date = new Date(dateStr + 'T12:00:00');
          return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', timeZone: 'UTC' });
        } catch (e) {
          return dateStr;
        }
      };

      const formatTime = (timeStr) => {
        try {
          // timeStr is in format "HH:MM" (24-hour)
          const [hours, minutes] = timeStr.split(':');
          const hour = parseInt(hours, 10);
          const ampm = hour >= 12 ? 'PM' : 'AM';
          const hour12 = hour % 12 || 12; // Convert 0 to 12
          return `${hour12}:${minutes} ${ampm}`;
        } catch (e) {
          return timeStr;
        }
      };

      return (
        <div className="bg-white rounded-lg shadow-md p-4">
          <div className="flex justify-between items-start mb-3">
            <div className="flex-1">
              {/* Event Title - Same size as date/time */}
              <h2 className="text-xl font-bold text-green-900 mb-1">
                {session.title || 'Golf Session'}
              </h2>
              {/* Date and Time - Same font size as title */}
              <p className="text-xl text-green-900 mb-2">
                {formatDate(session.date)} ‚Ä¢ {formatTime(session.time)}
              </p>
              {/* Location - Smaller text */}
              <p className="text-sm text-green-700">
                üìç {session.location}
              </p>
              {/* Custom message - Smaller text */}
              {session.message && (
                <p className="text-sm text-green-600 mt-1 italic border-l-4 border-green-300 pl-2 py-1">
                  {session.message}
                </p>
              )}
            </div>
            <div className="flex flex-col gap-2 ml-2 items-end">
              {/* Small Bushwood Logo */}
              <img 
                src="https://i.ibb.co/9dRb3qs/IMG-0216.webp" 
                alt="Bushwood"
                className="w-16 h-auto rounded"
              />
              {/* Share Button */}
              <button
                onClick={() => onShare(session)}
                className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-xs whitespace-nowrap"
              >
                üì§ Share
              </button>
              {/* Delete Button */}
              {onDelete && (
                <button
                  onClick={() => onDelete(session.id)}
                  className="px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-xs whitespace-nowrap"
                >
                  Delete
                </button>
              )}
            </div>
          </div>

          {/* Attendance Summary */}
          <div className="bg-green-50 rounded-lg p-3 mb-3">
            <div className="flex justify-around text-center">
              <div>
                <div className="text-2xl font-bold text-green-700">{attendingCount}</div>
                <div className="text-xs text-green-600">Coming</div>
              </div>
              <div className="border-l border-green-200"></div>
              <div>
                <div className="text-2xl font-bold text-gray-500">{outCount}</div>
                <div className="text-xs text-gray-600">Can't Make It</div>
              </div>
            </div>
          </div>

          {/* RSVP Buttons */}
          {!showNameInput ? (
            <div className="flex gap-2 mb-3">
              <button
                onClick={() => handleRSVP('in')}
                className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium text-sm"
              >
                ‚úì I'm In
              </button>
              <button
                onClick={() => handleRSVP('out')}
                className="flex-1 px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition font-medium text-sm"
              >
                ‚úó Can't Make It
              </button>
            </div>
          ) : (
            <div className="mb-3 space-y-2">
              <input
                type="text"
                placeholder="Enter your name"
                value={name}
                onChange={(e) => setName(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleRSVP(pendingStatus)}
                className="w-full px-3 py-2 border border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm"
                autoFocus
              />
              <div className="flex gap-2">
                <button
                  onClick={() => handleRSVP(pendingStatus)}
                  className={`flex-1 px-4 py-2 ${pendingStatus === 'in' ? 'bg-green-600' : 'bg-gray-400'} text-white rounded-lg hover:opacity-90 transition text-sm`}
                >
                  Confirm
                </button>
                <button
                  onClick={() => {
                    setShowNameInput(false);
                    setPendingStatus(null);
                    setName('');
                  }}
                  className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm"
                >
                  Cancel
                </button>
              </div>
            </div>
          )}

          {/* Attendee Lists */}
          {attendingList.length > 0 && (
            <div className="mb-2">
              <h3 className="font-semibold text-green-800 mb-1 text-sm">Coming ({attendingCount})</h3>
              <div className="space-y-1">
                {attendingList.map((attendee) => (
                  <div key={attendee.key} className="flex justify-between items-center bg-green-50 px-2 py-1 rounded text-sm">
                    {editingAttendee === attendee.key ? (
                      <div className="flex-1 flex gap-2 items-center">
                        <input
                          type="text"
                          value={editName}
                          onChange={(e) => setEditName(e.target.value)}
                          className="flex-1 px-2 py-1 border border-green-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500 text-sm"
                          autoFocus
                        />
                        <button
                          onClick={() => saveEdit(attendee.key, 'in')}
                          className="text-green-600 hover:text-green-800 text-xs font-medium"
                        >
                          Save
                        </button>
                        <button
                          onClick={cancelEdit}
                          className="text-gray-500 hover:text-gray-700 text-xs"
                        >
                          Cancel
                        </button>
                      </div>
                    ) : (
                      <>
                        <span className="text-green-900 text-sm">‚úì {attendee.name}</span>
                        <div className="flex gap-2">
                          <button
                            onClick={() => handleEdit(attendee)}
                            className="text-blue-500 hover:text-blue-700 text-xs"
                          >
                            Edit
                          </button>
                          <button
                            onClick={() => onRemoveAttendee(session.id, attendee.key)}
                            className="text-red-500 hover:text-red-700 text-xs"
                          >
                            Cancel
                          </button>
                        </div>
                      </>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {outList.length > 0 && (
            <div>
              <h3 className="font-semibold text-gray-600 mb-1 text-sm">Can't Make It ({outCount})</h3>
              <div className="space-y-1">
                {outList.map((attendee) => (
                  <div key={attendee.key} className="flex justify-between items-center bg-gray-50 px-2 py-1 rounded text-sm">
                    {editingAttendee === attendee.key ? (
                      <div className="flex-1 flex gap-2 items-center">
                        <input
                          type="text"
                          value={editName}
                          onChange={(e) => setEditName(e.target.value)}
                          className="flex-1 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-gray-500 text-sm"
                          autoFocus
                        />
                        <button
                          onClick={() => saveEdit(attendee.key, 'out')}
                          className="text-green-600 hover:text-green-800 text-xs font-medium"
                        >
                          Save
                        </button>
                        <button
                          onClick={cancelEdit}
                          className="text-gray-500 hover:text-gray-700 text-xs"
                        >
                          Cancel
                        </button>
                      </div>
                    ) : (
                      <>
                        <span className="text-gray-600 text-sm">‚úó {attendee.name}</span>
                        <div className="flex gap-2">
                          <button
                            onClick={() => handleEdit(attendee)}
                            className="text-blue-500 hover:text-blue-700 text-xs"
                          >
                            Edit
                          </button>
                          <button
                            onClick={() => onRemoveAttendee(session.id, attendee.key)}
                            className="text-red-500 hover:text-red-700 text-xs"
                          >
                            Cancel
                          </button>
                        </div>
                      </>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<GolfRSVP />, document.getElementById('root'));
  </script>
</body>
</html>
